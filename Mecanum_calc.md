# 4륜 메카넘(X 패턴) 역기구학 문서 (회전 중심: 차체 중심)

본 문서는 **차체 중심을 기준 회전 중심점(Body origin)** 으로 두고,
차체의 **병진 속도 벡터**와 **회전(요) 각속도**를 결합하여
각 바퀴의 **각속도(rad/s) 및 rpm**을 계산하는 표준 역기구학(Body twist → Wheel speed)을 정리한다.

---

## 0. 전제 및 주의사항

- 4개 메카넘 휠, 롤러 각도 **45°** 가정
- 휠은 **X 패턴** 장착(대각선끼리 롤러 방향이 같게 보이는 일반적인 구성)
- 바닥과의 접촉에서 슬립/탄성 변형은 무시(이상 모델)
- 결과 부호는 아래 **좌표계/바퀴 회전 양(+) 정의**에 의해 결정됨  
  (실제 조립에서 모터 극성/기어 방향이 다르면 소프트웨어에서 부호 보정 필요)

---

## 1. 좌표계 및 입력 변수 정의

### 1.1 차체 좌표계 (Body frame)
- `+x` : 전방(Forward)
- `+y` : 좌측(Left)
- `+z` : 상방(Up)
- 요 회전 각속도 `ω` 는 `+z` 축 기준, **반시계(CCW)** 를 양(+)으로 정의

### 1.2 기구 파라미터
- 휠 지름: `W_d`  (m 또는 mm, 단위 일관성 유지)
- 휠 반지름:
  $$
  r = \frac{W_d}{2}
  $$
- 휠 중심 간격(축간 거리):
  - 전후 거리: `X_d`
  - 좌우 거리: `Y_d`
- 반거리(차체 중심 기준 휠 좌표를 간단히 하기 위해 사용):
  $$
  L_x = \frac{X_d}{2}, \quad L_y = \frac{Y_d}{2}
  $$

### 1.3 차체 속도(입력, Body twist)
- 병진 속도 벡터:
  $$
  \mathbf{v}=
  \begin{bmatrix}
  v_x\\
  v_y
  \end{bmatrix}
  $$
- 요 각속도:
  $$
  \omega
  $$

---

## 2. “병진 + 회전” 결합 개념 (강체 운동)

회전 중심점을 차체 중심(원점)으로 둘 때,
차체의 임의 점(여기서는 각 바퀴 위치)의 속도는 다음으로 표현된다.

$$
\mathbf{v}_i =
\begin{bmatrix}
v_x\\ v_y
\end{bmatrix}
+
\begin{bmatrix}
-\omega\,y_i\\
\ \omega\,x_i
\end{bmatrix}
$$

단, 본 문서의 최종 목표(휠 각속도)는 보통 아래 **메카넘 역기구학 행렬**로 바로 계산한다.
(위 식은 물리적 의미/확장(예: 오프셋 제어점) 설명에 유용)

---

## 3. 메카넘(X 패턴, 45°) 역기구학: 차체 속도 → 바퀴 각속도

바퀴 순서를 다음으로 둔다.

1) `FL` = Front-Left  
2) `FR` = Front-Right  
3) `RL` = Rear-Left  
4) `RR` = Rear-Right

차체 속도 \([v_x, v_y, \omega]^T\) 가 주어졌을 때,
각 바퀴의 회전 각속도(rad/s)는 다음이다.

### 3.1 행렬 형태 (권장)
$$
\begin{bmatrix}
\omega_{FL}\\
\omega_{FR}\\
\omega_{RL}\\
\omega_{RR}
\end{bmatrix}
=
\frac{1}{r}
\begin{bmatrix}
1 & -1 & -(L_x+L_y)\\
1 & \ \ 1 & \ \ (L_x+L_y)\\
1 & \ \ 1 & -(L_x+L_y)\\
1 & -1 & \ \ (L_x+L_y)
\end{bmatrix}
\begin{bmatrix}
v_x\\
v_y\\
\omega
\end{bmatrix}
$$

### 3.2 전개 형태
$$
\omega_{FL}=\frac{1}{r}\left(v_x - v_y -(L_x+L_y)\omega\right)
$$
$$
\omega_{FR}=\frac{1}{r}\left(v_x + v_y +(L_x+L_y)\omega\right)
$$
$$
\omega_{RL}=\frac{1}{r}\left(v_x + v_y -(L_x+L_y)\omega\right)
$$
$$
\omega_{RR}=\frac{1}{r}\left(v_x - v_y +(L_x+L_y)\omega\right)
$$

---

## 4. 단위 변환: rad/s → rpm

$$
rpm_i = \omega_i \cdot \frac{60}{2\pi}
$$

---

## 5. 단위 테스트(부호/장착 검증) 체크리스트

아래 테스트는 “X 패턴/좌표계/부호”가 문서와 일치하는지 빠르게 검증한다.
(실기기에서는 모터 배선/감속기 방향 때문에 추가 부호 반전이 필요할 수 있음)

### 5.1 순수 전진
- 입력: $v_x>0,\ v_y=0,\ \omega=0$
- 기대: $\omega_{FL}=\omega_{FR}=\omega_{RL}=\omega_{RR}$ (동일 부호/동일 크기)

### 5.2 순수 좌이동
- 입력: $v_x=0,\ v_y>0,\ \omega=0$
- 기대:  
  - $FR, RL$ : 양(+)  
  - $FL, RR$ : 음(-)

### 5.3 순수 CCW 회전(차체 중심 기준)
- 입력: $v_x=0,\ v_y=0,\ \omega>0$
- 기대:  
  - $FR, RR$ : 양(+)  
  - $FL, RL$ : 음(-)

---

## 6. 곡선(경로) 추종 시 트위스트 구성 예시 (회전 중심은 여전히 차체 중심)

“경로 접선 방향으로 차체가 진행”하도록 제어한다면, 흔히 다음처럼 둔다.

- 경로 진행 속도: `v`
- 곡률: `κ` (또는 곡률반경 `R = 1/κ`)
- 차체 x축이 접선과 일치한다고 가정하면:
  $$
  v_x = v,\quad v_y = 0,\quad \omega = \kappa v = \frac{v}{R}
  $$
이렇게 얻은 \((v_x, v_y, \omega)\)를 **3절 역기구학**에 넣으면 휠 속도가 계산된다.

---

## 7. 구현 절차 요약

1) 입력 파라미터 준비: `W_d`, `X_d`, `Y_d`, `v_x`, `v_y`, `ω`  
2) 반지름/반거리 계산:  
   - $r=W_d/2,\ L_x=X_d/2,\ L_y=Y_d/2$
3) $S=L_x+L_y$ 계산
4) 3절 식으로 $\omega_{FL,FR,RL,RR}$ 계산 (rad/s)
5) 필요 시 4절로 rpm 변환
6) 5절 단위 테스트로 부호/장착 검증 후, 모터 극성 보정 적용

---


---

## 8. 트러블슈팅: 패턴/인덱스/배선이 달라도 혼동 없이 맞추는 방법

현장에서 가장 흔한 문제는 다음 셋이다.

1) 메카넘 장착 패턴이 문서와 다르다 (X 패턴 vs O 패턴)  
2) 바퀴 인덱스(FL/FR/RL/RR)가 코드와 실물이 다르다  
3) 모터 배선/감속기 방향 때문에 “회전 양(+)”이 반대로 들어간다  

이 섹션은 **문제 발생 시 빠르게 진단하고 수정하는 절차**를 제공한다.

---

### 8.1 먼저 결론: “행렬을 외워서 고치지 말고, 부호 맵으로 고친다”

역기구학은 본질적으로 아래 형태다.

$$
\omega_i = \frac{1}{r}\Big(a_i\,v_x + b_i\,v_y + c_i\,\omega\Big)
$$

여기서 각 바퀴마다 $(a_i,b_i,c_i)$는 **±1 또는 ±(L_x+L_y)** 형태이며,
패턴/인덱스/배선 차이는 결국 이 계수의 **부호 또는 바퀴 순서(행)** 문제로 귀결된다.

따라서,
- **바퀴 순서가 다르면**: 행(FL/FR/RL/RR)을 재배열
- **모터 방향이 반대면**: 해당 바퀴 출력에 -1을 곱함
- **패턴(X/O)이 다르면**: \(v_y\) 또는 \(\omega\) 항의 부호 패턴이 달라짐

---

### 8.2 표준 단위 테스트 3종으로 “현재 로봇의 부호 맵”을 확정한다

아래 입력을 아주 작은 값으로 넣고(예: 0.1 m/s, 0.1 rad/s),
각 바퀴가 실제로 어느 방향으로 도는지 관찰(엔코더 부호 또는 육안)한다.

#### 테스트 A: 순수 전진
- 입력: $v_x>0,\ v_y=0,\ \omega=0$
- 기대(정상이라면): 4개 휠 모두 같은 부호로 회전
- 관찰 결과로 얻는 것:
  - 각 바퀴의 "전진에 대한 부호" $a_i$ (정상이면 모두 +1이 되도록 맞춘다)

#### 테스트 B: 순수 좌이동
- 입력: $v_x=0,\ v_y>0,\ \omega=0$
- 기대(문서의 X 패턴 기준):  
  - $FR, RL$ : +  
  - $FL, RR$ : -
- 관찰 결과로 얻는 것:
  - 각 바퀴의 "측면 이동에 대한 부호" $b_i$
  - 만약 전부 반대로 나오면, 패턴/축 정의/모터 방향 중 하나가 뒤집힌 것

#### 테스트 C: 순수 CCW 회전(차체 중심)
- 입력: $v_x=0,\ v_y=0,\ \omega>0$
- 기대(문서의 X 패턴 기준):  
  - $FR, RR$ : +  
  - $FL, RL$ : -
- 관찰 결과로 얻는 것:
  - 각 바퀴의 "회전에 대한 부호" $c_i$

> 이 3개 테스트로, “내 로봇이 실제로 구현한 (a_i, b_i, c_i) 부호 맵”을 실측으로 확정할 수 있다.

---

### 8.3 바퀴 인덱스가 다를 때(FL/FR/RL/RR가 코드와 실물이 다름)

증상:
- 전진은 되는데 좌이동/회전이 이상하거나 대각 이동이 틀어진다.

해결:
- 코드에서 사용하는 바퀴 벡터 순서가 실물과 같은지 확인한다.
- 가장 빠른 방법:
  1) 테스트 A에서 “실물 FL이라고 생각한 바퀴”가 실제로 코드의 어느 채널인지 확인
  2) 동일하게 FR, RL, RR을 매칭
  3) 역기구학 결과 벡터를 **실물 순서에 맞게 행 재배열**한다.

즉, “행렬이 틀린 게 아니라, 결과 벡터의 **바퀴 매핑(인덱스)이 틀린 것**”인 경우가 많다.

---

### 8.4 모터 배선/감속기 때문에 특정 바퀴만 방향이 반대일 때

증상:
- 전진 입력에서 특정 바퀴만 반대로 돈다(즉시 드러남)

해결:
- 그 바퀴 채널에 대해:
  $$
  \omega_i \leftarrow -\omega_i
  $$
- 소프트웨어적으로는 "motor_dir[i] ∈ {+1, -1}" 같은 보정 계수를 둬서:
  $$
  \omega_i^{(cmd)} = motor\_dir[i]\cdot \omega_i^{(calc)}
  $$
- 반드시 테스트 A를 다시 수행해 전진이 정상인지 확인한다.

---

### 8.5 X 패턴 vs O 패턴을 구분하고 맞추는 실전 방법(외형만 믿지 않는다)

#### 핵심 관찰 포인트
- **전진 테스트(A)는 X/O 패턴과 무관하게** “4개 모두 같은 부호”가 되도록 맞추는 게 우선이다.
- 패턴 차이는 주로 **측면 이동(B)과 회전(C)에서 부호 조합이 달라지는 형태**로 드러난다.

#### 판별 절차
1) 테스트 A로 각 바퀴의 모터 방향을 먼저 맞춰 “전진 정상”을 만든다.
2) 테스트 B(좌이동) 결과의 부호 패턴을 기록한다.
3) 테스트 C(회전) 결과의 부호 패턴을 기록한다.

- 만약 B와 C 모두에서, 문서의 X 패턴 기대와 “대각선 그룹이 뒤집혀” 나온다면:
  - 장착이 O 패턴이거나, X 패턴을 가정한 행렬에서 \(v_y\) 또는 \(\omega\) 항 부호가 반대로 적용된 상태일 가능성이 높다.

#### 실무적 해결(권장)
- “패턴을 눈으로 단정”하기보다,
- 8.2에서 실측한 \((a_i,b_i,c_i)\)를 그대로 사용해 **내 로봇 전용 부호 맵 행렬**을 만든다.

즉, 로봇별로 아래 형태의 행렬을 “캘리브레이션 결과”로 확정한다.

$$
\begin{bmatrix}
\omega_1\\\omega_2\\\omega_3\\\omega_4
\end{bmatrix}
=
\frac{1}{r}
\begin{bmatrix}
a_1 & b_1 & c_1(S)\\
a_2 & b_2 & c_2(S)\\
a_3 & b_3 & c_3(S)\\
a_4 & b_4 & c_4(S)
\end{bmatrix}
\begin{bmatrix}
v_x\\v_y\\\omega
\end{bmatrix}
\quad,\quad S=L_x+L_y
$$

여기서 \(c_i(S)\)는 \(\pm S\) 이며, 부호는 테스트 C로 확정한다.

> 요약: X/O 패턴 논쟁을 “정답 행렬 찾기”로 풀지 말고,  
> **3개 테스트로 내 로봇의 부호 맵을 확정**하는 방식이 가장 빠르고 오류가 적다.

---

### 8.6 빠른 진단 표(증상 → 원인 후보)

- 전진이 안 되고 제자리에서 비틀린다  
  → 인덱스(행) 매핑 오류 또는 일부 모터 방향 반전 누락

- 전진은 되는데 좌이동이 대각으로 샌다  
  → 인덱스 오류 가능성이 가장 큼(FL/FR/RL/RR 교차), 다음으로 패턴 불일치

- 전진/좌이동은 되는데 회전이 반대로 돈다  
  → \(\omega\) 부호 정의(ω>0의 의미) 또는 IMU/제어계에서 ω 부호 반전

- 특정 방향에서만 “한쪽이 과하게 미끄러지는” 느낌  
  → 이상 모델 한계(마찰/하중/롤러 상태), 기구 편차, 바닥 재질 영향 가능

---

### 8.7 현장 권장 체크리스트(최단 해결 루트)

1) 바퀴 인덱스(FL/FR/RL/RR)가 코드 채널과 일치하는지 확정  
2) 테스트 A로 모터 방향 보정(motor_dir) 적용 → 전진 정상 확보  
3) 테스트 B, C로 부호 패턴 기록 → (b_i, c_i) 확정  
4) 최종적으로 “내 로봇 전용 부호 맵 행렬”을 고정  
5) 마지막으로, 실제 주행에서 속도/가속 제한과 슬립을 고려해 튜닝

---
