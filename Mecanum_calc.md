# 4륜 메카넘(X 패턴) 역기구학 문서 (전역 좌표계 → 차체 제어)

본 문서는 **전역 좌표계에서의 속도 명령**을 입력으로 받아,
차체의 현재 회전 각도를 고려하여 **차체 좌표계로 변환**한 후,
각 바퀴의 **각속도(rad/s) 및 rpm**을 계산하는 표준 역기구학을 정리한다.

---

## 0. 전제 및 주의사항

- 4개 메카넘 휠, 롤러 각도 **45°** 가정
- 휠은 **X 패턴** 장착(대각선끼리 롤러 방향이 같게 보이는 일반적인 구성)
- 바닥과의 접촉에서 슬립/탄성 변형은 무시(이상 모델)
- 결과 부호는 아래 **좌표계/바퀴 회전 양(+) 정의**에 의해 결정됨  
  (실제 조립에서 모터 극성/기어 방향이 다르면 소프트웨어에서 부호 보정 필요)

---

## 1. 좌표계 및 입력 변수 정의

### 1.1 전역 좌표계 (World frame)
- `+X` : 고정된 전방 기준축 (예: 맵의 북쪽, 필드의 정면 등)
- `+Y` : 고정된 좌측 기준축
- `+Z` : 상방(Up)
- 차체의 현재 방향(yaw 각도 `θ`)은 전역 좌표계 기준으로 측정
- `θ = 0` : 차체가 전역 +X 방향을 향함
- `θ > 0` : 반시계(CCW) 회전

### 1.2 차체 좌표계 (Body frame)
- `+x` : 차체 전방(Forward)
- `+y` : 차체 좌측(Left)
- `+z` : 상방(Up)
- 요 회전 각속도 `ω` 는 `+z` 축 기준, **반시계(CCW)** 를 양(+)으로 정의

### 1.3 기구 파라미터
- 휠 지름: `W_d`  (m 또는 mm, 단위 일관성 유지)
- 휠 반지름:
  $$
  r = \frac{W_d}{2}
  $$
- 휠 중심 간격(축간 거리):
  - 전후 거리: `X_d`
  - 좌우 거리: `Y_d`
- 반거리(차체 중심 기준 휠 좌표를 간단히 하기 위해 사용):
  $$
  L_x = \frac{X_d}{2}, \quad L_y = \frac{Y_d}{2}
  $$

### 1.4 입력 속도 (전역 좌표계 기준)
- 전역 좌표계에서의 병진 속도 벡터:
  $$
  \mathbf{V}_{world}=
  \begin{bmatrix}
  V_X\\
  V_Y
  \end{bmatrix}
  $$
- 차체의 현재 yaw 각도: `θ` (전역 좌표계 기준, IMU 또는 odometry로 측정)
- 요 각속도:
  $$
  \omega
  $$

---

## 2. 좌표 변환: 전역 좌표계 → 차체 좌표계

차체가 전역 좌표계에서 각도 `θ`만큼 회전되어 있을 때,
전역 좌표계에서의 속도 명령을 차체 좌표계로 변환해야 합니다.

### 2.1 회전 변환 행렬

$$
\begin{bmatrix}
v_x\\
v_y
\end{bmatrix}
=
\begin{bmatrix}
\cos\theta & \sin\theta\\
-\sin\theta & \cos\theta
\end{bmatrix}
\begin{bmatrix}
V_X\\
V_Y
\end{bmatrix}
$$

이는 다음과 같이 전개됩니다:

$$
v_x = V_X \cos\theta + V_Y \sin\theta
$$
$$
v_y = -V_X \sin\theta + V_Y \cos\theta
$$

### 2.2 물리적 의미와 예시

- **차체가 회전하지 않은 경우** (`θ = 0`):
  - $v_x = V_X$ (전역 X 방향 = 차체 전방)
  - $v_y = V_Y$ (전역 Y 방향 = 차체 좌측)
  - **예**: 전역 북쪽(+X)으로 1 m/s 명령 → 차체도 전방(+x)으로 1 m/s

- **차체가 90° 반시계 회전한 경우** (`θ = 90°`, 차체가 동쪽을 향함):
  - $v_x = V_Y$ (전역 Y 방향이 차체 전방이 됨)
  - $v_y = -V_X$ (전역 X 방향이 차체 우측이 됨)
  - **예**: 전역 북쪽(+X)으로 1 m/s 명령 → 차체는 우측(-y)으로 1 m/s 이동하여 결과적으로 북쪽으로 가게 됨

- **차체가 -90° (시계방향) 회전한 경우** (`θ = -90°`, 차체가 서쪽을 향함):
  - $v_x = -V_Y$ (전역 -Y 방향이 차체 전방이 됨)
  - $v_y = V_X$ (전역 X 방향이 차체 좌측이 됨)
  - **예**: 전역 북쪽(+X)으로 1 m/s 명령 → 차체는 좌측(+y)으로 1 m/s 이동하여 결과적으로 북쪽으로 가게 됨

### 2.3 핵심 개념

**차체가 회전하더라도 전역 좌표계에서의 목표 방향은 일정하게 유지됩니다.**

예를 들어, "전역 북쪽으로 계속 전진하라"는 명령을 주면:
- 차체가 0° 일 때: 차체 전방으로 이동
- 차체가 90° 회전하면: 차체 우측으로 이동 (전역 북쪽은 차체 우측이 되므로)
- 차체가 180° 회전하면: 차체 후방으로 이동 (전역 북쪽은 차체 뒤가 되므로)

이 변환을 통해 **회전하는 차체가 전역 좌표계에서 원하는 방향으로 이동**할 수 있습니다.

---

## 3. 메카넘(X 패턴, 45°) 역기구학: 차체 좌표계 속도 → 바퀴 각속도

바퀴 순서를 다음으로 둔다.

1) `FL` = Front-Left  
2) `FR` = Front-Right  
3) `RL` = Rear-Left  
4) `RR` = Rear-Right

**2절에서 변환된** 차체 좌표계 속도 \([v_x, v_y, \omega]^T\) 가 주어졌을 때,
각 바퀴의 회전 각속도(rad/s)는 다음이다.

### 3.1 행렬 형태 (권장)
$$
\begin{bmatrix}
\omega_{FL}\\
\omega_{FR}\\
\omega_{RL}\\
\omega_{RR}
\end{bmatrix}
=
\frac{1}{r}
\begin{bmatrix}
1 & -1 & -(L_x+L_y)\\
1 & +1 & +(L_x+L_y)\\
1 & +1 & -(L_x+L_y)\\
1 & -1 & +(L_x+L_y)
\end{bmatrix}
\begin{bmatrix}
v_x\\
v_y\\
\omega
\end{bmatrix}
$$

### 3.2 전개 형태
$$
\omega_{FL}=\frac{1}{r}\left(v_x - v_y -(L_x+L_y)\omega\right)
$$
$$
\omega_{FR}=\frac{1}{r}\left(v_x + v_y +(L_x+L_y)\omega\right)
$$
$$
\omega_{RL}=\frac{1}{r}\left(v_x + v_y -(L_x+L_y)\omega\right)
$$
$$
\omega_{RR}=\frac{1}{r}\left(v_x - v_y +(L_x+L_y)\omega\right)
$$

---

## 4. 단위 변환: rad/s → rpm

$$
rpm_i = \omega_i \cdot \frac{60}{2\pi}
$$

---

## 5. 단위 테스트(부호/장착 검증) 체크리스트

아래 테스트는 "X 패턴/좌표계/부호"가 문서와 일치하는지 빠르게 검증한다.
(실기기에서는 모터 배선/감속기 방향 때문에 추가 부호 반전이 필요할 수 있음)

**주의**: 이 테스트는 **차체 좌표계**에서 수행합니다 (θ = 0으로 가정).

### 5.1 순수 전진
- 입력: $v_x>0,\ v_y=0,\ \omega=0$
- 기대: $\omega_{FL}=\omega_{FR}=\omega_{RL}=\omega_{RR}$ (동일 부호/동일 크기)

### 5.2 순수 좌이동
- 입력: $v_x=0,\ v_y>0,\ \omega=0$
- 기대:  
  - $FR, RL$ : 양(+)  
  - $FL, RR$ : 음(-)

### 5.3 순수 CCW 회전(차체 중심 기준)
- 입력: $v_x=0,\ v_y=0,\ \omega>0$
- 기대:  
  - $FR, RR$ : 양(+)  
  - $FL, RL$ : 음(-)

---

## 6. 전체 시스템 검증 예시 (전역 좌표계 명령)

### 6.1 예시 1: 전역 북쪽으로 이동, 차체는 북쪽을 향함
- 전역 입력: $V_X = 1.0$ m/s, $V_Y = 0$, $\omega = 0$
- 차체 각도: $\theta = 0°$
- 변환: $v_x = 1.0$, $v_y = 0$
- 결과: 4개 바퀴 모두 동일한 속도로 회전 (순수 전진)

### 6.2 예시 2: 전역 북쪽으로 이동, 차체는 동쪽을 향함
- 전역 입력: $V_X = 1.0$ m/s, $V_Y = 0$, $\omega = 0$
- 차체 각도: $\theta = 90°$
- 변환: $v_x = 0$, $v_y = -1.0$
- 결과: 차체가 우측으로 이동 (FL, RR 음(-), FR, RL 양(+))
- **물리적 의미**: 차체는 동쪽을 향하지만, 우측(북쪽)으로 슬라이드하여 전역 북쪽으로 이동

### 6.3 예시 3: 전역 북쪽으로 이동하면서 회전
- 전역 입력: $V_X = 1.0$ m/s, $V_Y = 0$, $\omega = 0.5$ rad/s
- 차체 각도: $\theta = 45°$
- 변환: $v_x = 1.0 \cos(45°) = 0.707$, $v_y = -1.0 \sin(45°) = -0.707$
- 결과: 차체는 회전하면서도 전역 북쪽으로 이동

---

## 7. 구현 절차 요약

### 7.1 전체 계산 흐름

1) **입력 파라미터 준비**:
   - 기구: `W_d`, `X_d`, `Y_d`
   - 전역 좌표계 속도 명령: `V_X`, `V_Y`
   - 차체 현재 yaw 각도: `θ` (IMU 또는 odometry로 측정)
   - 요 각속도: `ω`

2) **기구 파라미터 계산**:
   - $r=W_d/2,\ L_x=X_d/2,\ L_y=Y_d/2$
   - $S=L_x+L_y$

3) **좌표 변환 (전역 → 차체)**:
   - $v_x = V_X \cos\theta + V_Y \sin\theta$
   - $v_y = -V_X \sin\theta + V_Y \cos\theta$

4) **역기구학 적용**:
   - 3절 식으로 $\omega_{FL,FR,RL,RR}$ 계산 (rad/s)

5) **단위 변환** (필요 시):
   - 4절로 rpm 변환

6) **검증 및 보정**:
   - 5절 단위 테스트로 부호/장착 검증 후, 모터 극성 보정 적용

### 7.2 의사 코드 (Pseudocode)

```python
# 입력
V_X, V_Y = 1.0, 0.0  # 전역 좌표계 목표 속도 (m/s)
theta = get_imu_yaw()  # 현재 차체 yaw 각도 (rad)
omega = 0.5  # 요 각속도 (rad/s)

# 기구 파라미터
W_d, X_d, Y_d = 0.1, 0.3, 0.3  # 휠 지름, 전후 거리, 좌우 거리 (m)
r = W_d / 2
L_x = X_d / 2
L_y = Y_d / 2
S = L_x + L_y

# 좌표 변환
v_x = V_X * cos(theta) + V_Y * sin(theta)
v_y = -V_X * sin(theta) + V_Y * cos(theta)

# 역기구학
omega_FL = (v_x - v_y - S * omega) / r
omega_FR = (v_x + v_y + S * omega) / r
omega_RL = (v_x + v_y - S * omega) / r
omega_RR = (v_x - v_y + S * omega) / r

# 모터 제어
set_motor_speeds(omega_FL, omega_FR, omega_RL, omega_RR)
```

### 7.3 실전 팁

1. **IMU/Odometry 필수**: 차체의 현재 각도 `θ`를 실시간으로 측정해야 합니다.
2. **좌표계 일관성**: 전역 좌표계를 명확히 정의하고 (예: 필드의 특정 벽 방향 = +X) 모든 센서와 일치시킵니다.
3. **단위 주의**: 각도는 라디안(rad), 속도는 m/s 또는 mm/s로 통일합니다.
4. **초기 캘리브레이션**: 차체를 전역 +X 방향으로 정렬하고 IMU를 0°로 초기화합니다.

---
