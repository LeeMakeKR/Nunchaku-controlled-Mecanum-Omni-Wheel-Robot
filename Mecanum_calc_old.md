# 4륜 메카넘(X 패턴) 역기구학 문서 (회전 중심: 차체 중심)

본 문서는 **차체 중심을 기준 회전 중심점(Body origin)** 으로 두고,
차체의 **병진 속도 벡터**와 **회전(요) 각속도**를 결합하여
각 바퀴의 **각속도(rad/s) 및 rpm**을 계산하는 표준 역기구학(Body twist → Wheel speed)을 정리한다.

---

## 0. 전제 및 주의사항

- 4개 메카넘 휠, 롤러 각도 **45°** 가정
- 휠은 **X 패턴** 장착(대각선끼리 롤러 방향이 같게 보이는 일반적인 구성)
- 바닥과의 접촉에서 슬립/탄성 변형은 무시(이상 모델)
- 결과 부호는 아래 **좌표계/바퀴 회전 양(+) 정의**에 의해 결정됨  
  (실제 조립에서 모터 극성/기어 방향이 다르면 소프트웨어에서 부호 보정 필요)

---

## 1. 좌표계 및 입력 변수 정의

### 1.1 전역 좌표계 (World frame)
- `+X` : 고정된 전방 기준축
- `+Y` : 고정된 좌측 기준축
- `+Z` : 상방(Up)
- 차체의 현재 방향(yaw 각도 `θ`)은 전역 좌표계 기준으로 측정
- `θ = 0` : 차체가 전역 +X 방향을 향함
- `θ > 0` : 반시계(CCW) 회전

### 1.2 차체 좌표계 (Body frame)
- `+x` : 차체 전방(Forward)
- `+y` : 차체 좌측(Left)
- `+z` : 상방(Up)
- 요 회전 각속도 `ω` 는 `+z` 축 기준, **반시계(CCW)** 를 양(+)으로 정의

### 1.3 기구 파라미터
- 휠 지름: `W_d`  (m 또는 mm, 단위 일관성 유지)
- 휠 반지름:
  $$
  r = \frac{W_d}{2}
  $$
- 휠 중심 간격(축간 거리):
  - 전후 거리: `X_d`
  - 좌우 거리: `Y_d`
- 반거리(차체 중심 기준 휠 좌표를 간단히 하기 위해 사용):
  $$
  L_x = \frac{X_d}{2}, \quad L_y = \frac{Y_d}{2}
  $$

### 1.4 입력 속도 (전역 좌표계 기준)
- 전역 좌표계에서의 병진 속도 벡터:
  $$
  \mathbf{V}_{world}=
  \begin{bmatrix}
  V_X\\
  V_Y
  \end{bmatrix}
  $$
- 차체의 현재 yaw 각도: `θ` (전역 좌표계 기준)
- 요 각속도:
  $$
  \omega
  $$

---

## 2. “병진 + 회전” 결합 개념 (강체 운동)

회전 중심점을 차체 중심(원점)으로 둘 때,
차체의 임의 점(여기서는 각 바퀴 위치)의 속도는 다음으로 표현된다.

$$
\mathbf{v}_i =
\begin{bmatrix}
v_x\\ v_y
\end{bmatrix}
+
\begin{bmatrix}
-\omega\,y_i\\
\ \omega\,x_i
\end{bmatrix}
$$

단, 본 문서의 최종 목표(휠 각속도)는 보통 아래 **메카넘 역기구학 행렬**로 바로 계산한다.
(위 식은 물리적 의미/확장(예: 오프셋 제어점) 설명에 유용)

---

## 3. 메카넘(X 패턴, 45°) 역기구학: 차체 속도 → 바퀴 각속도

바퀴 순서를 다음으로 둔다.

1) `FL` = Front-Left  
2) `FR` = Front-Right  
3) `RL` = Rear-Left  
4) `RR` = Rear-Right

차체 속도 \([v_x, v_y, \omega]^T\) 가 주어졌을 때,
각 바퀴의 회전 각속도(rad/s)는 다음이다.

### 3.1 행렬 형태 (권장)
$$
\begin{bmatrix}
\omega_{FL}\\
\omega_{FR}\\
\omega_{RL}\\
\omega_{RR}
\end{bmatrix}
=
\frac{1}{r}
\begin{bmatrix}
1 & -1 & -(L_x+L_y)\\
1 & \ \ 1 & \ \ (L_x+L_y)\\
1 & \ \ 1 & -(L_x+L_y)\\
1 & -1 & \ \ (L_x+L_y)
\end{bmatrix}
\begin{bmatrix}
v_x\\
v_y\\
\omega
\end{bmatrix}
$$

### 3.2 전개 형태
$$
\omega_{FL}=\frac{1}{r}\left(v_x - v_y -(L_x+L_y)\omega\right)
$$
$$
\omega_{FR}=\frac{1}{r}\left(v_x + v_y +(L_x+L_y)\omega\right)
$$
$$
\omega_{RL}=\frac{1}{r}\left(v_x + v_y -(L_x+L_y)\omega\right)
$$
$$
\omega_{RR}=\frac{1}{r}\left(v_x - v_y +(L_x+L_y)\omega\right)
$$

---

## 4. 단위 변환: rad/s → rpm

$$
rpm_i = \omega_i \cdot \frac{60}{2\pi}
$$

---

## 5. 단위 테스트(부호/장착 검증) 체크리스트

아래 테스트는 “X 패턴/좌표계/부호”가 문서와 일치하는지 빠르게 검증한다.
(실기기에서는 모터 배선/감속기 방향 때문에 추가 부호 반전이 필요할 수 있음)

### 5.1 순수 전진
- 입력: $v_x>0,\ v_y=0,\ \omega=0$
- 기대: $\omega_{FL}=\omega_{FR}=\omega_{RL}=\omega_{RR}$ (동일 부호/동일 크기)

### 5.2 순수 좌이동
- 입력: $v_x=0,\ v_y>0,\ \omega=0$
- 기대:  
  - $FR, RL$ : 양(+)  
  - $FL, RR$ : 음(-)

### 5.3 순수 CCW 회전(차체 중심 기준)
- 입력: $v_x=0,\ v_y=0,\ \omega>0$
- 기대:  
  - $FR, RR$ : 양(+)  
  - $FL, RL$ : 음(-)

---

## 6. 곡선(경로) 추종 시 트위스트 구성 예시 (회전 중심은 여전히 차체 중심)

“경로 접선 방향으로 차체가 진행”하도록 제어한다면, 흔히 다음처럼 둔다.

- 경로 진행 속도: `v`
- 곡률: `κ` (또는 곡률반경 `R = 1/κ`)
- 차체 x축이 접선과 일치한다고 가정하면:
  $$
  v_x = v,\quad v_y = 0,\quad \omega = \kappa v = \frac{v}{R}
  $$
이렇게 얻은 \((v_x, v_y, \omega)\)를 **3절 역기구학**에 넣으면 휠 속도가 계산된다.

---

## 7. 구현 절차 요약

1) 입력 파라미터 준비: `W_d`, `X_d`, `Y_d`, `v_x`, `v_y`, `ω`  
2) 반지름/반거리 계산:  
   - $r=W_d/2,\ L_x=X_d/2,\ L_y=Y_d/2$
3) $S=L_x+L_y$ 계산
4) 3절 식으로 $\omega_{FL,FR,RL,RR}$ 계산 (rad/s)
5) 필요 시 4절로 rpm 변환
6) 5절 단위 테스트로 부호/장착 검증 후, 모터 극성 보정 적용

---


